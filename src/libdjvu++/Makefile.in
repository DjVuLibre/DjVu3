
# C- Copyright (c) 1999 AT&T Corp.  All rights reserved.
# C-
# C- This software may only be used by you under license from AT&T
# C- Corp. ("AT&T"). A copy of AT&T's Source Code Agreement is available at
# C- AT&T's Internet website having the URL <http://www.djvu.att.com/open>.
# C- If you received this software without first entering into a license with
# C- AT&T, you have an infringing copy of this software and cannot use it
# C- without violating AT&T's intellectual property rights.
# C-
# C- $Id: Makefile.in,v 1.45 1999-09-21 14:38:08 leonb Exp $

SHELL=/bin/sh
prefix=@prefix@
bindir=@prefix@/bin
libdir=@prefix@/lib
incdir=@prefix@/include
SRCDIR=@srcdir@
TOPSRCDIR=@topsrcdir@
TOPBUILDDIR=@topbuilddir@
VPATH=@srcdir@
CXX=@cxx@
OPT=@opt@
WARN=@warn@
DEFS=@defs@
CXXFLAGS= $(DEFS) $(OPT) $(WARN) -I$(SRCDIR) -DUNIX
LDFLAGS=
DOCXX=@docxx@
LIBS=@libs@
MAKESTLIB=@make_stlib@
MAKESHLIB=@make_shlib@
RANLIB=@ranlib@


# Release info

NAM= libdjvu++
VER= 2.3

# This 
LIB= libdjvu++.a
PROG= djvudump c44 d44 djvutopnm djvumake djvuextract ppmcoco bzz djvmcvt # djvm

# Makefile for libdjvu++.a

LIBOBJS= DjVuGlobal.o GOS.o GException.o GContainer.o GString.o \
	 GThreads.o GRect.o GSmartPointer.o  MMX.o Arrays.o debug.o \
	 GBitmap.o GPixmap.o GScaler.o \
	 ByteStream.o IFFByteStream.o BSByteStream.o ZPCodec.o \
	 JB2Image.o IWTransform.o IWImage.o \
	 DataPool.o GURL.o DjVuFileCache.o DjVuPort.o GHLObjects.o \
	 DjVuAnno.o DjVuInfo.o DjVuFile.o DjVuImage.o DjVuDocument.o\
	 DjVmDir.o DjVmDoc.o DjVmDir0.o DjVuNavDir.o \
	 DjVuText.o

# Make all

all: lib prog

lib: $(LIB)

prog: $(PROG)



# Rule for building the library

$(LIB): $(LIBOBJS) 
	if [ -r $(LIB) ] ; then rm $(LIB) ; fi
	if [ -n "$(RPO)" ] ; then $(RPO) $(LIBOBJS) ; fi
	if [ -n "$(MAKESTLIB)" ] ; then $(MAKESTLIB) $(LIB) $(LIBOBJS) ; $(RANLIB) $(LIB) ; fi

# Rules for building support programs

DJVMOBJS = djvm.o
DJVMCVTOBJS = djvmcvt.o
C44OBJS = c44.o
D44OBJS = d44.o
DJVUDUMPOBJS = djvudump.o
DJVUTOPNMOBJS = djvutopnm.o
MAKEDEJAVUOBJS = djvumake.o
BREAKDEJAVUOBJS = djvuextract.o
PPMCOCOOBJS = ppmcoco.o
ANNOTATEOBJS = annotate.o
BZZOBJS = bzz.o

djvmcvt: $(DJVMCVTOBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(DJVMCVTOBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(DJVMCVTOBJS) $(LIB) $(LIBS)

djvm: $(DJVMOBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(DJVMOBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(DJVMOBJS) $(LIB) $(LIBS)

c44: $(C44OBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(C44OBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(C44OBJS) $(LIB) $(LIBS)

d44: $(D44OBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(D44OBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(D44OBJS) $(LIB) $(LIBS)

djvudump: $(DJVUDUMPOBJS) $(LIB) 
	if [ -n "$(RPO)" ] ; then $(RPO) $(DJVUDUMPOBJS) $(LIB)  ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(DJVUDUMPOBJS) $(LIB) $(LIBS)

djvutopnm: $(DJVUTOPNMOBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(DJVUTOPNMOBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(DJVUTOPNMOBJS) $(LIB) $(LIBS)

djvumake: $(MAKEDEJAVUOBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(MAKEDEJAVUOBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(MAKEDEJAVUOBJS) $(LIB) $(LIBS)

djvuextract: $(BREAKDEJAVUOBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(BREAKDEJAVUOBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(BREAKDEJAVUOBJS) $(LIB) $(LIBS)

ppmcoco: $(PPMCOCOOBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(PPMCOCOOBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(PPMCOCOOBJS) $(LIB) $(LIBS)

annotate: $(ANNOTATEOBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(ANNOTATEOBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(ANNOTATEOBJS) $(LIB) $(LIBS)

bzz: $(BZZOBJS) $(LIB)
	if [ -n "$(RPO)" ] ; then $(RPO) $(BZZOBJS) $(LIB) ; fi
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@  $(BZZOBJS) $(LIB) $(LIBS)

# Documentation

html: libdjvu++.dxx libdjvu++.footer
	-rm -rf Doc
	-mkdir Doc 2>/dev/null
	${DOCXX} -d Doc -B $(SRCDIR)/libdjvu++.footer $(SRCDIR)/libdjvu++.dxx

tex:  libdjvu++.dxx
	-@mkdir Doc 2>/dev/null
	${DOCXX} -t -o Doc/libdjvu++.tex -ep fullpage $(SRCDIR)/libdjvu++.dxx
	( cd Doc ; latex libdjvu++.tex ; latex libdjvu++.tex )
	dvips Doc/libdjvu++.dvi -o
	gzip -f libdjvu++.ps


# Cleaning

clean:
	-rm 2>/dev/null -rf $(PROG) ; true
	-rm 2>/dev/null *.o *.a *.out *.rpo *.dep ii_files ; true
	if [ -d Test ] ; then ( cd Test ; $(MAKE) clean ) ; fi

realclean:
	-rm 2>/dev/null -rf Doc libdjvu++.ps.gz ; true
	-rm 2>/dev/null -rf Makefile.depend ; true
	-@$(MAKE) clean


# Installing

install: install-prog install-lib

install-prog: $(PROG)
	-@mkdir $(prefix) 2>/dev/null
	-@mkdir $(bindir) 2>/dev/null
	for n in $(PROG); do        \
	  cp $$n $(bindir)        ; \
	  chmod 755 $(bindir)/$$n ; \
	done

install-lib: $(LIB)
	-@mkdir $(prefix) 2>/dev/null
	-@mkdir $(libdir) 2>/dev/null
	for n in $(LIB); do        \
	  cp $$n $(libdir)        ; \
	  chmod 644 $(libdir)/$$n ; \
	  $(RANLIB) $(libdir)/$$n ; \
	done


# Dependencies

depend:
	( echo "### DEPENDENCIES" ;\
	  for n in $(SRCDIR)/*.cpp ; \
	  do ${CXX} -MM $(CXXFLAGS) $$n ; done ) > Makefile.depend
	sed -e '/^### DEPENDENCIES$$/,$$d' Makefile > Makefile.new
	cat Makefile.depend >> Makefile.new
	mv Makefile.new Makefile
	  

# Misc

release:
	$(MAKE) realclean
	$(MAKE) depend
	$(MAKE) libdjvu++.dxx
	$(MAKE) tex
	$(MAKE) html
	$(MAKE) capsule

capsule:
	$(MAKE) distclean
	@attcapsule ATTLICENSE ../$(NAM)-$(VER).tar.gz
	@echo Distribution is in ../$(NAM)-$(VER).tar.gz


PHONY: all lib prog \
       install install-lib install-prog \
       clean realclean html tex depend \
       release capsule

# Handle cpp files as C++

.SUFFIXES: .cpp
.cpp.o:
	$(CXX) $(CXXFLAGS) -c $(SRCDIR)/$*.cpp


