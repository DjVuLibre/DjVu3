#!/bin/sh
# LIBDJVU++ -- Decoding library and utilities


### ---------------------------
### Determine directories

conf=`basename $0`
if [ ! -r `dirname $0`/config/functions.sh ]
then
    echo 1>&2 "$conf: Cannot recognize source directory"
    echo 1>&2 "--  Check that your source directory is complete."
    exit 1
fi


### ---------------------------
### Get functions

. `dirname $0`/config/functions.sh

### ---------------------------
### Process arguments

for arg 
do
  case $arg in 
    --with-threads=* )
      threads=`echo $arg | sed 's/[-A-Za-z_]*=//'` 
      ;; 
    --with-rpo|--frepo )
      rpo=yes
      ;;
    *)
      if process_general_option $arg
      then true  
      else
        test $arg = --help || echo 1>&2 "$conf: Unrecognized option '$arg'"
        echo 1>&2 "Usage: $conf <options>"
        echo 1>&2 "Recognized options:"
        list_general_options
        echo 1>&2 "  --with-threads=(no|co|posix|dce)          choose a thread implementation."
        echo 1>&2 "  --with-rpo,--frepo                        use --frepo option in G++."
        exit 1 
      fi
      ;;
   esac
done


### ---------------------------
### Want a distinct compilation directory

if [ $TOPSRCDIR = $TOPBUILDDIR ]
then
    echo 1>&2 "$conf: Cannot compile in the source directory"
    echo 1>&2 "--  You must mkdir a compilation directory and"
    echo 1>&2 "    call $conf from there."
    exit 1
fi


### ---------------------------
### Proceed

check_compiler
check_debug_option $debug
check_thread_option $threads
check_library log -lm
check_rpo_option $rpo
check_make_stlib


### ---------------------------
### Build makefiles

generate_makefile src/libdjvu++
generate_makefile src/libdjvu++/Test

generate_main_makefile src/libdjvu++ <<\EOF

all: 
	( cd src/libdjvu++; $(MAKE) lib prog )

install:
	( cd src/libdjvu++; $(MAKE) install-lib install-prog )

EOF



### ------------------------------------------------------------------------
### Success


# --- save command line

echo '#!/bin/sh' > "$TOPBUILDDIR/reconfigure"
echo "$0 $*" >> "$TOPBUILDDIR/reconfigure"
chmod 755 "$TOPBUILDDIR/reconfigure"

# --- display cool message

. "${CONFIG_DIR}/write_cache.sh"

echo
echo Configuration is complete.
echo You can proceed with the compilation by typing:
                              echo "    make clean"
test -n "$compiler_is_gcc" && echo "    make depend"
                              echo "    make all"
echo





